<h2 id="js-for-journos-building-narrative-with-geo-data--cartodb">JS for Journos: Building narrative with geo data + CartoDB</h2>

<p>Aurelia Moser, Map Scientist, <a href="http://cartodb.com">CartoDB</a></p>

<p>Workshop - NICAR Session <a href="http://ire.org/events-and-training/event/1494/1646/">Link</a></p>

<p>Atlanta, Georgia</p>

<p><strong>March 6, 2015, 3:20PM-4:20PM</strong></p>

<p>Find this document here:</p>

<ul>
  <li>Stackedit: <a href="https://stackedit.io/viewer#!provider=gist&amp;gistId=ae2d6602353d9e63c91a&amp;filename=nicar_15_mappingjs.md">http://bit.ly/1BMad7n</a></li>
  <li>Gist: <a href="https://gist.github.com/auremoser/ae2d6602353d9e63c91a">http://bit.ly/1BciteV</a></li>
</ul>

<p>Find the code checkpoints here:</p>

<ul>
  <li>Github: <a href="https://github.com/auremoser/nicar-2015">https://github.com/auremoser/nicar-2015</a></li>
  <li><a href="http://bl.ocks.org/auremoser/a90356af6669ccdc11ae">Crash-Pop Demo</a></li>
  <li><a href="http://bl.ocks.org/auremoser/af95a29cd76267d3925e">Crash-Pop Chart</a></li>
</ul>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/flag-ga.png" alt="Georgia State Flag from Wikipedia" /></p>

<h1 id="outline">Outline</h1>
<ol>
  <li>Visualizing Data
    <ul>
      <li>Why Maps?</li>
    </ul>
  </li>
  <li>Introduction to CartoDB
    <ul>
      <li>Examples</li>
      <li>Tour of the interface</li>
      <li>APIs / JS Libs</li>
    </ul>
  </li>
  <li>Mapping <strong>Basics</strong>
    <ul>
      <li>Setting up accounts!
  	+ Data import</li>
      <li>Datasets</li>
    </ul>
  </li>
  <li>Mapping <strong>Data</strong>
    <ul>
      <li>Getting Geospatial Data
  	+ Data representation in CartoDB (SQL schema)</li>
      <li>Geocoding + SQL/PostGIS</li>
      <li>Merging Tables</li>
      <li>Customizing UI</li>
    </ul>
  </li>
  <li>Building a Map
    <ul>
      <li>Basics of <code class="highlighter-rouge">VisJson</code> (<a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-1-visjson">ckpt-1</a>)</li>
      <li>Quick map with <code class="highlighter-rouge">CreateVis</code> (<a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-2-createVis">ckpt-2</a>)</li>
      <li>Custom map with <code class="highlighter-rouge">CreateLayer</code> <a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-3-createLayer">(ckpt-3</a>)</li>
      <li>Add SQL/CSS Templates (<a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-4-sqlcss">ckpt-4</a>)</li>
      <li>Add Interactivity - Buttons (<a href="https://github.com/auremoser/nicar-2015/tree/master/ckpt-5-buttons">ckpt-5</a>)</li>
      <li>Infowindows (<a href="https://github.com/auremoser/nicar-2015/tree/master/ckpt-6-info">ckpt-6</a>)</li>
      <li>BONUS: Charts (<a href="https://github.com/auremoser/nicar-2015/tree/master/ckpt-7-chart">ckpt-7</a>)</li>
    </ul>
  </li>
  <li>Building a Narrative
    <ul>
      <li>Case Study: GA - Onomatopeoia Map</li>
      <li><a href="http://bl.ocks.org/auremoser/a90356af6669ccdc11ae">CrashPop_Demo</a></li>
      <li>Tell Time/Stories: Odyssey + Torque</li>
      <li>Datatelling: Graphs + Charts</li>
    </ul>
  </li>
  <li>Wrap-Up and Resources</li>
</ol>

<h1 id="visualizing-data">Visualizing Data</h1>
<p><img src="https://raw.githubusercontent.com/auremoser/images/master/1-vis-types.png" alt="Types of Visualizations" /></p>

<p>Source: <a href="http://www.datavizcatalogue.com/">The Data Visualization Catalogue</a>.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/periodic.png" alt="PeriodicTable" /></p>

<p>Source: <a href="http://www.visual-literacy.org/periodic_table/periodic_table.html">Periodic Table of Visualizations</a></p>

<p><a href="cartodb.com"><strong>CartoDB</strong></a> is a light open source library and graphical user interface application for hosting and visualizing geospatial data.</p>

<p><img src="https://raw.githubusercontent.com/ohasselblad/workshops/master/img/common/data_import_dialog.png" alt="Data import dialog" /></p>

<h1 id="intro-to-cartodb">Intro to CartoDB</h1>
<p>## Examples
+ <a href="http://www.washingtonpost.com/news/morning-mix/wp/2014/12/15/the-alcatraz-escapees-could-have-survived-and-this-interactive-model-proves-it/">Alcatraz Escape Revisited</a>
+ <a href="http://graphics.latimes.com/2014-la-sheriff-primary-map/">LA Sheriff Election Results</a>
+ <a href="http://www.swgalaxymap.com/">Starwars Galaxy Map</a>
+ <a href="http://blog.cartodb.com/mapping-the-world-ongoing-demonstrations-in-brazil/">Demonstrations in Brazil</a>
+ <a href="http://www.globalforestwatch.org/map/3/15.00/27.00/ALL/grayscale/loss,forestgain?begin=2001-01-01&amp;end=2013-12-31&amp;threshold=30">Global Forest Watch</a>
+ <a href="http://www.urbanreviewer.org/#map=12/40.7400/-73.9998&amp;sidebar=plans">Urban Reviewer</a></p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/globalforest.png" alt="globalForestWatch" /></p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/urban_reviewer_code_example.png" alt="urban-reviewer" /></p>

<h2 id="tour-of-the-interface">Tour of the interface</h2>
<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/int-data.jpg" alt="int-data" />
<img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/int-upload.jpg" alt="int-upload" />
<img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/int-viz.jpg" alt="int-vis" />
<img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/int-share.jpg" alt="int-share" />
## APIs / JS Libs
You can read more about the <a href="http://docs.cartodb.com/cartodb-platform.html">CartoDB APIs and JS Library here</a>
* <a href="http://docs.cartodb.com/cartodb-platform/cartodb-js.html">CartoJS</a> - JS library for interacting with CartoDB
* <a href="http://docs.cartodb.com/cartodb-platform/maps-api.html">Maps API</a> - generate public/private maps with data hosted on your CDB account
* <a href="http://docs.cartodb.com/cartodb-platform/sql-api.html">SQL API</a> - run sql in your code that dynamically filters/affects/queries your mapped data stored in CartoDB
* <a href="http://docs.cartodb.com/cartodb-platform/import-api.html">Import API</a> - CRUD files in your CartoDB Account</p>

<h1 id="mapping-basics">Mapping Basics</h1>
<p>## Setting Up Accounts
You can setup a <em>free</em> student account today since we’re all learning: <a href="https://cartodb.com/signup?plan=academy">https://cartodb.com/signup?plan=academy</a></p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/ire.png" alt="ire" /></p>

<p>IRE members are eligible for a free upgraded account that includes:</p>

<ul>
  <li>more space</li>
  <li>private tables (<a href="http://cartodb.com/pricing">a Magellan account feature</a>)</li>
  <li>sync tables</li>
</ul>

<p>Email cartodb@ire.org with your request for an upgraded account and membership ID, and we’ll set you up.</p>

<h2 id="data-import">Data Import</h2>
<p>We’re going to be building a visualization of traffic accidents in Georgia.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/2-countyChoro.png" alt="countychoropleth" /></p>

<p>We’ll be mapping crash/fatalities from motor accidents (c. 2006) and census population data (c. 2010) for a Crash/Pop map (what I’ve called an “onomatopoeia map,” <a href="http://www.noisehelp.com/examples-of-onomatopoeia.html">just because</a>).</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/trafficTweet.png" alt="Problem" /></p>

<p>Traffic accidents are pretty common/available datasets, as is census information. We’ll be building a choropleth of traffic accidents, resulting in fatality and crash/injury reports percapita.</p>

<h2 id="datasets">Datasets</h2>
<p>You can download the datasets we’ll be working with, and the files for the workshop here.</p>

<table>
  <thead>
    <tr>
      <th>Description</th>
      <th>Source</th>
      <th>Download</th>
      <th>Dropbox</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2010 Georgia Census Demographics</td>
      <td><a href="http://www.atlantaregional.com/info-center/2010-census">Atlanta Regional Data</a></td>
      <td><a href="https://www.dropbox.com/s/6j6j5vt616yq2ek/atl_census_demo_2010.geojson?dl=1">pop_2010</a></td>
      <td><a href="https://www.dropbox.com/s/6j6j5vt616yq2ek/atl_census_demo_2010.geojson?dl=0">pop_2010</a></td>
    </tr>
    <tr>
      <td>Traffic Fatality Data</td>
      <td><a href="http://www.gahighwaysafety.org/research/data-by-county/">GA Office of Highway Safety</a></td>
      <td><a href="https://www.dropbox.com/s/7rvrpkytll3bq1e/traffic_accidents.geojson?dl=1">crash_2006</a></td>
      <td><a href="https://www.dropbox.com/s/7rvrpkytll3bq1e/traffic_accidents.geojson?dl=0">crash_2006</a></td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/4-trafficData.png" alt="trafficData" /></p>

<h1 id="mapping-data">Mapping Data</h1>
<p>## Getting Geospatial Data</p>

<p><strong>Geospatial data</strong> is info that ids a geolocation and its characteristic features/frontiers, typically represented by points, lines, polygons, and/or complex geographic features.</p>

<h3 id="issues">Issues:</h3>
<ul>
  <li>Comes in multiple formats (<a href="http://docs.cartodb.com/cartodb-editor.html#supported-file-formats">supported formats for CartoDB</a>)</li>
  <li>Sources uncertain</li>
  <li>Contains errors</li>
  <li>etc.</li>
</ul>

<p>Downloading the <a href="http://www.gahighwaysafety.org/research/data-by-county/">Traffic Data</a> and the <a href="http://www.atlantaregional.com/info-center/2010-census">Census Data</a> requires some finessing.</p>

<h3 id="data-check">Data Check:</h3>

<ul>
  <li>check the source and update date of your data</li>
  <li>remove headers/extra columns (in Excel or Open Refine)</li>
  <li>import the csv/geojson and auto-geocoding via carto</li>
  <li>correct column names to more intelligible terms</li>
  <li>correct datatypes</li>
  <li>do any preliminary sql or filtering that suits</li>
</ul>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/6-datatypes.png" alt="correctDatatypes" /></p>

<p>The sets I’ve prepared should give you “cleaner” data. Here are the fields, or columns, we’ll be focusing on:</p>

<ul>
  <li><strong>Georgia Census Data</strong> - names of counties and population counts</li>
  <li><strong>Georgia Traffic Data</strong> - names of counties, crash counts, fatality counts (injury counts are also available)</li>
</ul>

<p>Here is what it might look like when you upload your data:</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/1-geocoding.png" alt="Geocoding" /></p>

<h2 id="data-representation-in-cartodb-sql-schema">Data representation in CartoDB (SQL schema)</h2>
<p>The most basic SQL statement is:</p>

<p><code class="highlighter-rouge">sql
SELECT * FROM table_name
</code></p>

<p>The * means everything. This means that all rows and columns from the table are given back once the query is run.</p>

<p>A more detailed query is like this:</p>

<p><code class="highlighter-rouge">sql
SELECT
  name,
  height,
  age
FROM
  class_list
WHERE
  name = 'Aure'
  AND (
    height &gt; 1.2
    OR
    height &lt; 1.9
  )
</code></p>

<ol>
  <li><code class="highlighter-rouge">SELECT</code> is what you’re requesting (required)</li>
  <li><code class="highlighter-rouge">FROM</code> is where the data is located (required)</li>
  <li><code class="highlighter-rouge">WHERE</code> is the filter on the data you’re requesting (optional)</li>
  <li><code class="highlighter-rouge">GROUP BY</code> and <code class="highlighter-rouge">ORDER BY</code> are optional additions, you can read more about aggregate/other functions below.</li>
</ol>

<h2 id="geocoding--sqlpostgis">Geocoding + SQL/PostGIS</h2>
<p>There are two special columns in CartoDB:</p>

<ol>
  <li><code class="highlighter-rouge">the_geom</code></li>
  <li><code class="highlighter-rouge">the_geom_webmercator</code></li>
</ol>

<p>The first of these is in the units of standard latitude/longitude, while the second is a projection based on the <a href="http://en.wikipedia.org/wiki/Mercator_projection">original Mercator projection</a> but <a href="http://en.wikipedia.org/wiki/Web_Mercator">optimized for the web</a>.</p>

<p>If you want to run SQL commands and see your map update, make sure to <code class="highlighter-rouge">SELECT</code> the <code class="highlighter-rouge">the_geom_webmercator</code> because this is the column that’s used for mapping–the other is more of a convenience column since most datasets use lat/long.</p>

<p>This is a SQL statement and you can load it in your visualization tray as a way of querying and exploring your data with immediate visual output. In this case the Traffic Accident data is aliased to “ta” and the Atlanta Census data is aliased to “ac”.</p>

<p><code class="highlighter-rouge">sql
SELECT ac.the_geom_webmercator, ta.county_name, 100000 * ta.number_fatality / ac.population fatalities_per_capita
      FROM
        traffic_accidents ta, atl_census_demo_2010 ac
      WHERE ac.county_name = ta.county_name
</code></p>

<p>This is a query that adds some more information from the sample, to include percapita counts of the fatality and crash data available in your datasets.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/0-sql.png" alt="sql" /></p>

<p>You can enter queries, apply them, click on “create table from query” in the green field below the column names.</p>

<h2 id="merging-tables">Merging Tables</h2>
<p>Joining and merging tables to make one dataset is a common need. Say you have two datasets related to the same place/map and need to combine them so that they can share the same geometry.</p>

<p>You can do this in SQL <a href="http://docs.cartodb.com/tutorials/merging_data.html">read more here</a>, but CartoDB also has an in-editor button for that.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/5-mergeButton.png" alt="mergeButton" /></p>

<p>Here is a usecase relative to these datasets:</p>

<ul>
  <li>when you download the traffic data from source, it has county names but no polygon or geospatial reference</li>
  <li><a href="https://www.dropbox.com/s/eyq2p1uzg2njifx/ga-counties.kml?dl=0">this dataset</a> has polygon info for georgia counties, as well as a corresponding column of county names</li>
  <li>you can load them both into cartodb, and select the “merge tables” button</li>
  <li>select <code class="highlighter-rouge">column</code> or <code class="highlighter-rouge">spatial</code> join</li>
</ul>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/5-joins.png" alt="joins" /></p>

<ul>
  <li>select the columns that you want to join on, in this case, both datasets share a “county_name” column</li>
</ul>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/5-merge.png" alt="merge" /></p>

<ul>
  <li>toggle the columns you want to exist in your new “joined” dataset</li>
</ul>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/5-mergeGen.png" alt="mergGen" /></p>

<h2 id="customizing-ui">Customizing UI</h2>
<p>Once you load both datasets, add them together as layers in the same visualization.</p>

<p>Navigate to your census data, select <code class="highlighter-rouge">Add layer</code>, create a visualization when prompted (titled something like <code class="highlighter-rouge">nicar-atl</code> or whatever you’d like).</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/0-wizard.png" alt="sql" /></p>

<p>You have myriad customization options in the in-browser editor.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/7-editorCustom.png" alt="editor customizations" /></p>

<ul>
  <li><code class="highlighter-rouge">sql</code> - run sql and postgis functions across your data</li>
  <li><code class="highlighter-rouge">wizard</code> - adjust the type, colors and fills in your map</li>
  <li><code class="highlighter-rouge">infowindow</code> - create hovers, tooltips with information from your datatables</li>
  <li><code class="highlighter-rouge">css</code> - customize the css and style of your map outside the wizard</li>
  <li><code class="highlighter-rouge">legends</code> - create keys for your map</li>
  <li><code class="highlighter-rouge">filters</code> - filter the data without sql</li>
</ul>

<p>You can also select and change your <code class="highlighter-rouge">basemaps</code> in the upper left corner of your map.</p>

<p><img src="https://raw.githubusercontent.com/ohasselblad/workshops/gh-pages/img/alaska/basemap_options.png" alt="basemap-options" /></p>

<p>All of these options can be cloned in javascript!</p>

<h1 id="building-a-map">Building a Map</h1>
<p>You can build any type of visualization that suits your data.</p>

<h4 id="types-of-visualizations">Types of visualizations</h4>
<ul>
  <li><strong>Simple</strong> – most basic visualization</li>
  <li><strong>Cluster</strong> – counts number of points within a certain binned region</li>
  <li><strong>Choropleth</strong> – makes a histogram of your data and gives bins different colors depending on the color ramp chosen</li>
  <li><strong>Category</strong> – color data based on unique category (works best for a handful of unique types)</li>
  <li><strong>Bubble</strong> – size markers based on column values</li>
  <li><strong>Intensity</strong> – colors by density</li>
  <li><strong>Density</strong> – data aggregated by number of points within a hexagon</li>
  <li><strong>Torque</strong> – temporal visualization of data (categorical and heatmap versions)</li>
</ul>

<p>Check out <a href="http://docs.cartodb.com/cartodb-editor.html#wizards">visualization documentation</a> for more.</p>

<h4 id="choropleth">Choropleth</h4>
<p>We’ll be making choropleths because we have county-level polygon data for Georgia.</p>

<p>Choropleth maps show map elements colored according to where a value associated with the map element falls in a range. It’s like a histogram where each bin is colored differently according to a color scale you pick.</p>

<ul>
  <li><strong><em>Quantification</em></strong> is an option to pay attention to since it controls how the data is binned into different colors.</li>
  <li><strong><em>Equal interval</em></strong> gives bins of equal size across the range,  which means that outliers stand out.</li>
  <li><strong><em>Quantile</em></strong> bins so that each quantile has approximately the same number of values.</li>
</ul>

<p>Once you load your data, you can play with the editor options to see what type of visualization you might light to make. You can make a <code class="highlighter-rouge">population</code> choropleth for example, using the <code class="highlighter-rouge">population</code> data from your census table.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/3-population.png" alt="population" /></p>

<h2 id="quick-map-with-createvis">Quick map with <code class="highlighter-rouge">CreateVis</code></h2>
<p>#### Here’s a reference point for this section: <a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-1-visjson">ckpt-1</a></p>

<p>You will need:
+ datasets from above
+ visjson from your account, you can <a href="https://github.com/auremoser/nicar-test/blob/master/ckpt-1-visjson/vis.json">reference mine</a> to find yours too.
+ Basic Text Editor
+ Browser</p>

<h4 id="running-locally">Running Locally</h4>
<ul>
  <li>You can open HTML files on your hard drive from a browser. Use CMD+O or CTRL+O like you’d do to open a file in any program.</li>
  <li>You can also run a little server by navigating to the folder where you will store your files and running <code class="highlighter-rouge">http-server &amp;</code>; you have node installed with http-server setup!</li>
</ul>

<h3 id="visjson">VisJson</h3>

<p><img src="http://i.imgur.com/gVxeNMg.png" alt="Share-vizualization" /></p>

<p>The viz.json file is the main source of data for CartoDB JavaScript functions (createVis and createLayer) for creating visualizations in the browser.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/1-visJson.png" alt="visjson" /></p>

<ul>
  <li>Structure of file: JSON</li>
  <li>Defines how to access data: listing servers, subdomains, etc.</li>
  <li>Most important for developers is the <code class="highlighter-rouge">layers</code> array because it explicitly shows the structure of how visualizations are put together
    <ul>
      <li>Defines base maps, if applicable, as <code class="highlighter-rouge">layers[0]</code></li>
      <li>CartoDB data layer is <code class="highlighter-rouge">layers[1]</code>, may consist of multiple sublayers
        <ul>
          <li>Defines infowindows, which we’ll cover in this workshop</li>
          <li>Defines data accessed by using a SQL statement</li>
          <li>Defines styling for tile layers, if applicable</li>
          <li>Defines interactivity (what data shows up on layer events)</li>
          <li><code class="highlighter-rouge">layer_name</code> is the also the name of table where data comes from in the account with key <code class="highlighter-rouge">user_name</code></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>You can view it by opening a text editor and loading the file, or downloading a JSON viewer extension for inbrowser views (<a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc?hl=en">Chrome</a> or <a href="https://addons.mozilla.org/en-us/firefox/addon/jsonview/">Firefox</a>).</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/3-createVis.png" alt="createVisPreview" /></p>

<h3 id="creating-basic-visualization-in-javascript">Creating Basic Visualization in JavaScript</h3>

<p>Copy &amp; paste template from <a href="https://gist.github.com/auremoser/a57654e18ce06ab396d6">here</a>.</p>

<p>Overview of template:</p>

<ol>
  <li>Included JavaScript libraries and CSS file</li>
  <li><code class="highlighter-rouge">map</code> element</li>
  <li><code class="highlighter-rouge">&lt;script&gt;</code> tags</li>
</ol>

<p>Create basic visualization using <code class="highlighter-rouge">createVis</code> by copying and pasting the following either between script tags in your html or by making a file called <code class="highlighter-rouge">[?].js</code> (I used <code class="highlighter-rouge">main.js</code> in the template) and referencing it between your script tags:</p>

<p>```js
window.onload = function() {
    var vizjson_url = ‘’; // &lt;– Paste viz.json URL between quotes</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cartodb.createVis(map_id, vizjson_url) // &lt;-- Change map_id to 'map'
    .done(function(vis, layers) {
        // do stuff
        console.log("Map successfully created");
    })
    .error(function(err) {
        // report error
        console.log("An error occurred: " + err);
    }); } ```
</code></pre>
</div>

<p><code class="highlighter-rouge">createVis</code> is excellent for creating maps quickly with very little code. There is a lot of customization with it as well. The documentation is <a href="http://docs.cartodb.com/cartodb-platform/cartodb-js.html#visualization">here</a>.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/0-ckpt-createVis.png" alt="createVis" /></p>

<p><strong>Edit the fields to match your map reload your browser window, your map should work.</strong></p>

<h2 id="custom-map-with-createlayer">Custom map with <code class="highlighter-rouge">CreateLayer</code></h2>
<p>#### Here’s a reference point for this section: <a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-2-createVis">ckpt-2</a></p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/9-createLayer.png" alt="createLayer" /></p>

<p><code class="highlighter-rouge">createLayer</code> is the other main method for bring maps to your browser.</p>

<p>The following is the basic createLayer structure (depends on <a href="http://leafletjs.com/">Leaflet.js</a>):</p>

<p>```javascript
window.onload = function () {
  //
   var layerSource = ‘http://documentation.cartodb.com/api/v2/viz/ed78c85e-c11b-11e4-ab66-0e853d047bba/viz.json’; // add your url ID here between viz/ and /viz.json</p>

<p>var options = {
       sql: “SELECT * FROM atl_census_demo_2010”,
       cartocss: “#atl_census_demo_2010{polygon-fill:#0fa59f;}”
   }</p>

<p>var sublayers = [];</p>

<p>// instantiate map object from Leaflet
   var mapObj = new L.Map(map, {  // &lt;– use your map #id for rendering
       center: [31.7550, -84.3900], // Atlanta, Georgia
       zoom: 7 // zoom projection to adjust starting point zoom
   });</p>

<p>// add basemap tiles
   L.tileLayer(‘http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png’, {
       attribution: ‘© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors’
   }).addTo(mapObj);</p>

<p>// add data tile layer
   cartodb.createLayer(mapObj,layerSource)
       .addTo(mapObj)
       .done(function(layer) {
           console.log(“Map successfully created.”);
           sublayers[0] = layer.getSubLayer(0);
           sublayers[1] = layer.getSubLayer(1);
           sublayers[0].set(options); // altering the SQL and CartoCSS; see above
           sublayers[1].hide(); // hiding the traffic data
       })
       .error(function(err) {
           console.log(“Map not created: “ + err);
       });
}
```
One big difference here is that we explicitly expose the SQL and CartoCSS, allowing for easy customization.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/0-ckpt-createLayer.png" alt="createLayer" /></p>

<p><strong>Edit the fields to match your map reload your browser window, your map should work.</strong></p>

<h2 id="add-sqlcss-templates">Add SQL/CSS Templates</h2>
<p>#### Here’s a reference point for this section: <a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-3-createLayer">ckpt-3</a></p>

<p><strong>New goal:</strong> We’ll create an interactive map that allows us to toggle between the basic view and the view of crashes per county per capita.</p>

<p>To accomplish this, we need to know how many crashes happened per neighborhood, then divide that number by the population of the neighborhood.</p>

<p>You can do this a number of ways, we’ll be using SQL, you can read documentation on available function magic in the <a href="http://postgis.net/docs/">PostGIS docs</a> and otherwise just follow along.</p>

<p>Going back to the <code class="highlighter-rouge">createLayer</code> example we just made:</p>

<ul>
  <li>Copy the following SQL into your index.html file below the <code class="highlighter-rouge">&lt;style&gt;</code> tags.</li>
</ul>

<p><code class="highlighter-rouge">sql
&lt;script type='sql/text' id='sql'&gt;
      SELECT ac.the_geom_webmercator, ac.population, ta.county_name, ceil(100000 * ta. number_crash / ac. population) crashes_per_capita, ceil(100000 * ta.number_fatality / ac.population) fatalities_per_capita
      FROM
        traffic_accidents ta, atl_census_demo_2010 ac
      WHERE ac.county_name = ta.county_name
&lt;/script&gt;
</code></p>

<ul>
  <li>Paste the following CartoCSS structure in the <code class="highlighter-rouge">&lt;head&gt;</code> section of your webpage.</li>
  <li>This is a pre-configured Choropleth style. You could also create one on the fly by calculating the range in data and creating bins within that range.</li>
</ul>

<p>```css</p>
<style type="cartocss/text" id="choropleth">
    /** choropleth visualization */
    #atl_census_demo_2010{
      polygon-fill: #F1E6F1;
      polygon-opacity: 0.8;
      line-color: #FFF;
      line-width: 0.5;
      line-opacity: 1;
    }
    #atl_census_demo_2010 [ fatalities_per_capita <= 116.48223645894] {
       polygon-fill: #8A4E8A;
    }
    #atl_census_demo_2010 [ fatalities_per_capita <= 43.4522839606757] {
       polygon-fill: #A05AA0;
    }
    #atl_census_demo_2010 [ fatalities_per_capita <= 34.5685840707965] {
       polygon-fill: #B379B3;
    }
    #atl_census_demo_2010 [ fatalities_per_capita <= 27.2727272727273] {
       polygon-fill: #C08FC0;
    }
    #atl_census_demo_2010 [ fatalities_per_capita <= 21.2074084546868] {
       polygon-fill: #CCA5CC;
    }
    #atl_census_demo_2010 [ fatalities_per_capita <= 16.7128259001051] {
       polygon-fill: #D8BBD8;
    }
    #atl_census_demo_2010 [ fatalities_per_capita <= 12.3350191192796] {
       polygon-fill: #F1E6F1;
    }
</style>

<p>```</p>

<ul>
  <li>Next replace the string for `sql in the options object with</li>
</ul>

<p><code class="highlighter-rouge">javascript
$("#sql").text(),
</code></p>

<p>(don’t forget the comma!), and the string after <code class="highlighter-rouge">cartocss</code> with</p>

<p><code class="highlighter-rouge">javascript
$("#choropleth").text()
</code></p>

<p>These two pieces of code are just a jQuery operation that finds the HTML element that has an <code class="highlighter-rouge">id</code> of <code class="highlighter-rouge">sql</code> or <code class="highlighter-rouge">cartocss</code> and extracts the text contained within it.</p>

<ul>
  <li>add a sublayer reference to your data tile layer function at the end of your js:</li>
</ul>

<p><code class="highlighter-rouge">sublayers[0].set(options); // altering the SQL and CartoCSS; see above</code></p>

<p>Check <a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-4-sqlcss">the checkpoint code</a> here if you’re stuck. You can also run the SQL in the tray (not in the your local files) and the the map will populate. The advantage to adding it as a template, is that you can swap it for other SQL or run different queries with different template references locally, and you are not limited to one query option.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/0-ckpt-sqlcss.png" alt="createButtons" /></p>

<p><strong>Reload your browser window, your map should work!</strong></p>

<h2 id="add-interactivity---buttons">Add Interactivity - Buttons</h2>
<p>#### Here’s a reference point for this section: <a href="https://github.com/auremoser/nicar-test/tree/master/ckpt-4-sqlcss">ckpt-4</a></p>

<p>To add more interactivity, we’ll create two buttons to toggle between the <code class="highlighter-rouge">Simple</code> map view and the view that gives a choropleth map. We can easily do this in CartoDB by using the <code class="highlighter-rouge">sublayer.setSQL()</code> and <code class="highlighter-rouge">sublayer.setCartoCSS()</code> methods to change the data.</p>

<p>First, create another <code class="highlighter-rouge">&lt;style type="cartocss/text" id="simple"&gt;</code> tag set with the following CartoCSS style. Make sure the <code class="highlighter-rouge">id</code> is set to <code class="highlighter-rouge">simple</code></p>

<p><code class="highlighter-rouge">css
      /** simple visualization */
      #atl_census_demo_2010{
        polygon-fill: #0fa59f;
        polygon-opacity: 0.7;
        line-color: #FFF;
        line-width: 1;
        line-opacity: 1;
    }
</code></p>

<ul>
  <li>Next, let’s create some buttons. Put the following snippet below the <code class="highlighter-rouge">div</code> with an <code class="highlighter-rouge">id='map'</code>.</li>
</ul>

<p>```html</p>
<div id="cartocss" class="layer_selector">
        <p>Buttons</p>
        <ul>
            <li data="choropleth">Fatality Choropleth Per Capita</li>
            <li data="simple">Simple County Map</li>
        </ul>
</div>
<p>```</p>

<ul>
  <li>Wire up the buttons with click events:</li>
</ul>

<p>```js
function createSelector(layer) {
      var cartocss = “”;
      var $options = $(“.layer_selector”).find(“li”);
      $options.click(function(e) {
          var $li = $(e.target);
          var selected = $li.attr(‘data’);</p>

<div class="highlighter-rouge"><pre class="highlight"><code>      $options.removeClass('selected');
      $li.addClass('selected');

      cartocss = $('#'+selected).text();

      layer[0].setCartoCSS(cartocss);
  });    } ```
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/0-ckpt-buttons.png" alt="sqlcss" /></p>

<p>Examples:</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/quakes.png" alt="quake-sample" /></p>

<ul>
  <li><a href="http://jsfiddle.net/gh/get/library/pure/CartoDB/academy/tree/master/t/03-cartodbjs-ground-up/lesson-3/jsfiddle_demo_cartocss">JSFiddle with Selectors</a></li>
  <li><a href="http://docs.cartodb.com/tutorials/custom_interactivity.html">Interactivity tutorial</a></li>
  <li><a href="http://byndhack.herokuapp.com/">Advanced example</a></li>
</ul>

<h2 id="infowindows--more">Infowindows + More</h2>
<p>#### Here’s a reference point for this section <a href="https://github.com/auremoser/nicar-2015/tree/master/ckpt-6-info">ckpt-5</a></p>

<h3 id="adding-infowindows-in-editor">Adding infowindows in Editor</h3>
<p>You can enable hover infowindows in your editor, that will port to your map and give you some choropleth context.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/8-editorInfowindow2.png" alt="infowindows" /></p>

<ul>
  <li>customization in html/css</li>
  <li>all data in your table is available to you to populate the tooltips</li>
</ul>

<h3 id="adding-infowindows-in-js">Adding infowindows in JS</h3>
<ul>
  <li>HTML templates
    <ul>
      <li>Handlebar notation</li>
      <li>Customizing display of information</li>
      <li>Pulling in images</li>
    </ul>
  </li>
</ul>

<p>```html
<script type="infowindow/html" id="infowindow_template"></script></p>
<div class="cartodb-popup">
    <a href="#close" class="cartodb-popup-close-button close">x</a>
     <div class="cartodb-popup-content-wrapper">
       <div class="cartodb-popup-header">
         <img style="width: 100%" src="http://cartodb.com/assets/logos/logos_full_cartodb_light-5ef5e4ff558f4f8d178ab2c8faa231c1.png" />
       </div>
       <div class="cartodb-popup-content">
         <!-- content.data contains the field info -->
         <h4>County: </h4>
         <p></p>
       </div>
     </div>
     <div class="cartodb-popup-tip-container"></div>
  </div>
<p>&lt;/script&gt;
```</p>

<p>Then add this to the <code class="highlighter-rouge">options</code>:
<code class="highlighter-rouge">javascript
interactivity: 'cartodb_id, county_name'
</code></p>

<p>After <code class="highlighter-rouge">sublayers[0].set(...)</code>, add this:</p>

<p><code class="highlighter-rouge">javascript
sublayers[0].infowindow.set('template', $('#infowindow_template').html());
</code></p>

<ul>
  <li>Click events
    <ul>
      <li>On hover</li>
      <li>On click</li>
    </ul>
  </li>
</ul>

<p>You can build on this, or checkout the demo block here to view the result of your work with some limited interactivity!</p>

<h3 id="final-project-here-onomatopoeia-crashpop-maphttpblocksorgauremosera90356af6669ccdc11ae">Final project here: <a href="http://bl.ocks.org/auremoser/a90356af6669ccdc11ae">Onomatopoeia (Crash/Pop) Map</a></h3>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/0-ckpt-info.png" alt="info" /></p>

<h1 id="building-narrative">Building Narrative</h1>
<p>Outside of the CartoJS library, we have others to help you build dynamic narrative with your data.</p>

<h2 id="tell-time--stories">Tell Time + Stories</h2>

<p><strong>Maps that tell Time</strong> - <strong><a href="http://docs.cartodb.com/tutorials/introduction_torque.html">Torque</a></strong></p>

<iframe src="https://srogers.cartodb.com/viz/337d9194-6458-11e3-85b5-e5e70547d141/embed_map" width="100%" height="500px"></iframe>

<ol>
  <li><a href="http://blog.cartodb.com/mapping-the-world-ongoing-demonstrations-in-brazil/">Demonstrations in Brazil</a></li>
  <li>Tweets that mention <a href="http://cartodb.s3.amazonaws.com/static_vizz/sunrise.html">sunrise map</a></li>
  <li><a href="http://robbykraft.github.io/AnimalTrack/">Animal migration patterns</a></li>
  <li><a href="https://srogers.cartodb.com/viz/337d9194-6458-11e3-85b5-e5e70547d141/embed_map">Beyonce Album Release</a></li>
  <li><a href="http://bl.ocks.org/anonymous/raw/b9b7c7d6de1c6398e435/">Diwali Celebrated</a></li>
  <li><a href="http://bl.ocks.org/anonymous/raw/2f1e9a5a74ceeb88e977/">Ramadan Tweets w/OdysseyJS</a></li>
  <li><a href="http://www.washingtonpost.com/news/morning-mix/wp/2014/12/15/the-alcatraz-escapees-could-have-survived-and-this-interactive-model-proves-it/?tid=hp_mm&amp;hpid=z3">Alcatraz Escapees</a></li>
  <li><a href="http://yale.cartodb.com/u/mdweaver/viz/ffd06ece-8545-11e4-a898-0e018d66dc29/embed_map">Lynching and the Press</a></li>
</ol>

<p><img src="http://i.imgur.com/d3GSSYQ.gif" alt="Twitter Import" /></p>

<p><strong>Maps that tell Stories</strong> - <strong><a href="http://cartodb.github.io/odyssey.js/index.html">Odyssey JS</a></strong></p>

<ol>
  <li><a href="http://alasdair.cartodb.com/viz/1332c872-a887-11e4-8c45-0e9d821ea90d/embed_map?zoom=14&amp;center_lat=55.948595&amp;center_lon=-3.199913">Tour of Scotland</a></li>
  <li><a href="http://stream.aljazeera.com/projects/socialmediaconversation/"><em>Al Jazeera</em>: Israeli-Palestinian Conflict by Tweets</a></li>
  <li><a href="http://www.cadenaser.com/sonidos-11m/">The Sounds of 11M</a></li>
  <li><a href="http://bl.ocks.org/namessanti/raw/d5cf706f68b7c6dce9a3/#3">Berlin Wall Historic Tour</a></li>
  <li><a href="http://cartodb.com/v/maya-angelou#6">Maya Angelou Quotes</a></li>
</ol>

<h2 id="talk-data-in-charts">Talk Data in Charts</h2>
<p>You can use CartoDB’s SQL API to query your data and pull it into any charting library of your choosing.</p>

<p>You can easily wire up a chart of county-level traffic fatalities, <a href="http://bl.ocks.org/auremoser/af95a29cd76267d3925e">check the code here</a>.</p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/chartjs.png" alt="Chart-by-County" /></p>

<p>Learn more about it <a href="http://docs.cartodb.com/tips-and-tricks.html#charts--graphs">here</a>!</p>

<p>Here are some examples:</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Title</th>
      <th>Link/Demo</th>
      <th>BlogPost</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="http://www.chartjs.org/">Chart.js</a> Bar Graph</td>
      <td>Traffic Data</td>
      <td><a href="http://bl.ocks.org/auremoser/af95a29cd76267d3925e">Aurelia’s Block</a></td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="http://www.highcharts.com/">Highcharts</a></td>
      <td>Sensor Data</td>
      <td><a href="https://github.com/auremoser/VitalSigns-water/">Github</a> / <a href="http://auremoser.github.io/VitalSigns-water/">Demo</a></td>
      <td><a href="http://blog.cartodb.com/map-of-the-week-pulse-plotting/">MOW Post</a></td>
    </tr>
    <tr>
      <td><a href="http://www.highcharts.com/">Highcharts</a></td>
      <td>Weather Data</td>
      <td><a href="http://bl.ocks.org/auremoser/96b70f6dbcc724ecc973">Aurelia’s Block</a></td>
      <td><a href="https://stackedit.io/viewer#!provider=gist&amp;gistId=e2d4f0f0b71f258f3ac9&amp;filename=beirut.md">Tutorial</a></td>
    </tr>
    <tr>
      <td><a href="http://www.chartjs.org/">Chart.js</a> Line Graph</td>
      <td>Tornado Data</td>
      <td><a href="http://bl.ocks.org/andrewxhill/9134155">Andrew’s Block</a></td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="https://plot.ly/">Plot.ly</a></td>
      <td>Earthquake Data</td>
      <td><a href="https://plot.ly/ipython-notebooks/cartodb/">Plotly Tutorial</a></td>
      <td><a href="http://blog.cartodb.com/plotly/">CartoDB Blog</a></td>
    </tr>
  </tbody>
</table>

<h3 id="more">More</h3>
<ul>
  <li><code class="highlighter-rouge">sql.execute(SQL command)</code> to extract data from your account, place into charts, infowindows, etc.
    <ul>
      <li>Using <a href="http://bl.ocks.org/andrewxhill/9134155">Chart.js</a></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">sql.getBounds(SQL command)</code> to find the bounding box of data returned by SQL command
    <ul>
      <li><a href="http://robbykraft.github.io/AnimalTrack/">Porpoise Map</a></li>
    </ul>
  </li>
</ul>

<h1 id="resources">Resources</h1>
<p>##CartoDB
1. <a href="http://academy.cartodb.com">Map Academy</a>
    + <a href="http://academy.cartodb.com/courses/03-cartodbjs-ground-up/lesson-3.html">CartoDB.js</a> – build a web app to visualize your data, allowing for user interaction
	+ <a href="http://academy.cartodb.com/courses/04-sql-postgis.html">SQL and PostGIS</a>
2. <a href="http://docs.cartodb.com/tutorials.html">CartoDB Tutorials</a>
3. <a href="http://docs.cartodb.com/cartodb-editor.html">CartoDB Editor Documentation</a>
4. <a href="http://docs.cartodb.com/cartodb-platform.html">CartoDB APIs</a>
5. <a href="http://gis.stackexchange.com/questions/tagged/cartodb">Community help on StackExchange</a>
6. <a href="http://cartodb.com/gallery/">CartoDB Map Gallery</a></p>

<h2 id="data">Data</h2>
<ol>
  <li><a href="http://gis.atlantaga.gov/apps/gislayers/">GIS Layer Data for Georgia</a>
    <ul>
      <li>Tax Allocation Districts</li>
      <li>Public vs. Private School distribution</li>
      <li>Development districts
 Watershed management</li>
      <li>Bike and Transport Data</li>
    </ul>
  </li>
  <li><a href="http://arc.garc.opendata.arcgis.com/datasets/f37c6a6c451447f8af2693f736cd9044_12">ARC Census Data</a></li>
  <li><a href="http://arc.garc.opendata.arcgis.com/datasets/dc20713282734a73abe990995de40497_68">Georgia County Polygons</a></li>
</ol>

<h2 id="visualization">Visualization</h2>
<ol>
  <li><a href="https://github.com/auremoser/chart-tools">Charting Tools Repository</a></li>
  <li><a href="http://cartodb.github.io/training/">Workshops @CartoDB</a></li>
  <li><a href="http://selection.datavisualization.ch/">Recommended tools for visualizations</a></li>
  <li><a href="https://github.com/tmcw/perception">Perception concerns</a></li>
  <li><a href="http://colorbrewer2.org/">Colorbrewer</a> or <a href="http://geocolor.io/">Geocolor</a></li>
</ol>

<p>My contact: <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#097;&#117;&#114;&#101;&#108;&#105;&#097;&#064;&#099;&#097;&#114;&#116;&#111;&#100;&#098;&#046;&#099;&#111;&#109;">&#097;&#117;&#114;&#101;&#108;&#105;&#097;&#064;&#099;&#097;&#114;&#116;&#111;&#100;&#098;&#046;&#099;&#111;&#109;</a></p>

<p>If you make a map you’re proud of or just want to say hello, connect with me <a href="https://twitter.com/auremoser">@auremoser</a></p>

<p><img src="https://raw.githubusercontent.com/auremoser/nicar-test/master/img/seal-ga.jpg" alt="GA-Seal" /></p>
